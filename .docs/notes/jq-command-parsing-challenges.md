---
{}
---

# jqコマンド解析の技術的課題

Claude Code設定ファイルにおけるjqコマンドの解析と編集に関する技術的考察

## Background

Claude Codeのhooks設定では、jqコマンドをJSON文字列として一行で記述する必要がある。これにより以下の課題が発生している：

- エスケープ処理の複雑さ（シングルクォート、ダブルクォート、バックスラッシュ）
- 可読性の著しい低下
- 構文エラーの発見困難
- デバッグの困難さ

## Content

### 解析時の課題

1. **多重エスケープの処理**
   ```json
   "command": "jq -r 'if .tool_input.command | test(\"bun run dev\") then {\"decision\": \"block\", \"reason\": \"not allowed\"} else empty end'"
   ```
   上記のように、JSON内でjqコマンドを記述すると、クォートのエスケープが必要になる。

2. **改行の扱い**
   - JSON文字列内では改行を`\n`として記述する必要がある
   - 複数行のjqコマンドを一行に圧縮すると可読性が著しく低下

3. **構文検証の難しさ**
   - jqコマンドとして有効か
   - JSON文字列として有効か
   - 両方の検証が必要

### 解決アプローチ

1. **GUIでの複数行エディタ提供**
   - ユーザーは複数行でjqコマンドを記述
   - 保存時に自動で一行化とエスケープ処理

2. **リアルタイム構文チェック**
   - jqコマンドの構文を解析
   - エラー箇所をハイライト表示

3. **テスト実行機能**
   - サンプルJSONデータでjqコマンドを実行
   - 結果をプレビュー表示

4. **テンプレート機能**
   - よく使うパターンを登録
   - 変数部分のみ編集可能に

## Decisions

- 初期バージョンでは基本的なエスケープ処理とプレビュー機能を実装
- jqコマンドの完全な構文解析は将来のバージョンで検討
- WebAssemblyでjqを動作させる可能性も調査中

## Action Items

- [ ] jqコマンドパーサーの実装方針決定
- [ ] エスケープ処理ライブラリの選定
- [ ] テスト用サンプルデータの準備
- [ ] エラーメッセージの日本語化